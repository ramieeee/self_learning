**스팸메일 필터링**

[toc]

# 1. 배경 연구

## 1) 메일 서버 구축

1. DNS 서버
2. MX 레코드
3. Vmware 로컬 메일 서버 구축 공부 (postfix)

### a. 환경

* VMware
* CentOS7 64bit
* Windows 10 64bit
* postfix
* dovecot

## 2) 스팸 메일 차단 기술

- RBM 기술? 자연어 처리?

## 3) 결론

* 어떤점이 현 기술에 문제가 있는지 파악하고 대안 기법 확인 필요

# 2. 학습 파라미터

* 인간이 어떤 부분에서 메일을 스팸으로 분류하는지 확인해야함
* 메일 헤더, 내용, 메일이 어떻게 작동하는지 공부

# 3. 네임서버 구축

* mail.project.com(스팸 피해자) = 192.168.100.147
* mail.test.com(스팸 발신자) = 192.168.100.140
* DNS = 192.168.100.143

```
yum -y install bind bind-chroot
```

```
vim /etc/sysconfig/network

# project.com 서버
HOSTNAME=mail.project.com

# test.com 서버
HOSTNAME=mail.test.com
```

```
# DNS
vim /etc/named.conf

options {

# 나의 어떤 IP와 포트로 청취할 것인가의 옵션
listen-on port 53 { any; };

# 위 옵션과 같이 IPv6 의 IP 와 포트를 청취할 것인지 설정
listen-on-v6 port 53 { none; };

# 어떤 IP한테서의 쿼리를 허용할 것인지 설정
allow-query { any; };
};

dnssec-validation no;

# zone 설정
zone "project.com" IN {
        type master;
        file "project.com.db";
        allow-update { none; };
};

zone "test.com" IN {
        type master;
        file "test.com.db";
        allow-update { none; };
};
```

```
# name 서버
vim /var/named/project.com.db

$TTL    3H
@       SOA     @       root.   ( 2  1D  1H  1W  1H )
        IN      NS      @
        IN      A       192.168.100.147
        IN      MX      10      mail.project.com.

mail    IN      A       192.168.100.147
```

```
# name 서버
vim /var/named/test.com.db

$TTL    3H
@       SOA     @       root.   ( 2  1D  1H  1W  1H )
        IN      NS      @
        IN      A       192.168.100.140
        IN      MX      10      mail.test.com.

mail    IN      A       192.168.100.140
```

```
# 적용이 잘 되었는지 확인
named-checkconf
named-checkzone project.com project.com.db
named-checkzone test.com test.com.db
```

```
# 서비스 시작
systemctl restart named
systemctl enable named
```

```
# 방화벽 내리기
systemctl stop firewalld
systemctl disable firewalld
```

```
# nameserver 작동 확인
nslookup
> server 192.168.100.143
Default server: 192.168.100.143
Address: 192.168.100.143#53
> mail.project.com
Server:		192.168.100.143
Address:	192.168.100.143#53

Name:	mail.project.com
Address: 192.168.100.147
> mail.test.com
Server:		192.168.100.143
Address:	192.168.100.143#53

Name:	mail.test.com
Address: 192.168.100.140
```

```
# 각 서버에서 DNS 설정

# project.com, test.com 서버
nmcli con mod ens33 ipv4.dns 192.168.100.143
systemctl restart NetworkManager
reboot
```



# 4. 메일 서버 구축

* 참고자료

4. https://erider.co.kr/127 <- 메일 명령어 관련 블로그
5. https://cghsecurity.tistory.com/15?category=907152 <- 네임서버 구축
3. https://www.youtube.com/watch?v=iFMnYUvBqEA&list=PLVsNizTWUw7EJ9z-LW3lv3VC-6HI9I3hN&index=52 <- sendmail 서버 구축

## 1) sendmail 구축

```
yum -y install sendmail-cf dovecot
```

```
vim /etc/mail/sendmail.cf

# project.com 서버
85 Cwproject.com
264 O DaemonPortOptions=Port=smtp, Name=MTA

# test.com 서버
85 Cwtest.com
264 O DaemonPortOptions=Port=smtp, Name=MTA
```

```
# RELAY 메일 전달하는 기능 추가
vim /etc/mail/access

# project.com, test.com 서버
project.com     RELAY
test.com        RELAY
192.168.100     RELAY

# 두 서버 모두에서 설정한 내용 적용
makemap hash /etc/mail/access < /etc/mail/access
```

```
# 두 서버 모두
vim /etc/dovecot/conf.d/10-ssl.conf
8: ssl = yes
```

```
vim /etc/dovecot/conf.d/10-mail.conf

# 주석 해제
25 mail_location = mbox:~/mail:INBOX=/var/mail/%u
121 mail_access_groups = mail
166 lock_method = fcntl
```

```
systemctl restart sendmail
systemctl enable sendmail
```

# 5. Spamassassin 설치

## 1)

```
yum -y install spamassassin epel-release
```

```
# Mailbox 로 전송되기 전에 spamassassin 이 처리하도록 설정
vim /etc/procmailrc

# 아래 내용 추가
INCLUDERC=/etc/mail/spamassassin/spamassassin-default.rc
```

```
systemctl restart spamassassin
systemctl enable spamassassin
```

## 2)

```
# 기존 파일은 백업을 해두고 새로 local.cf 파일을 생성

mv /etc/mail/spamassassin/local.cf /etc/mail/spamassassin/local.cf.old
vim /etc/mail/spamassassin/local.cf

# SpamAssassin config file for version 3.x
# NOTE: NOT COMPATIBLE WITH VERSIONS 2.5 or 2.6
# See http://www.yrex.com/spam/spamconfig25.php for earlier versions
# Generated by http://www.yrex.com/spam/spamconfig.php (version 1.50)
# How many hits before a message is considered spam.
required_score           5.0

# Change the subject of suspected spam
rewrite_header subject         [SPAM]

# Encapsulate spam in an attachment (0=no, 1=yes, 2=safe)
report_safe             0

# Enable or disable network checks
skip_rbl_checks         0
use_razor2              0
use_dcc                 0
use_pyzor               1

# Mail using languages used in these country codes will not be marked
# as being possibly spam in a foreign language.
# – korean
ok_languages            all

# Mail using locales used in these country codes will not be marked
# as being possibly spam in a foreign language.
ok_locales              all
```

```
# MDA가 사용할 procmailrc 파일을 생성

# Pipe the mail through spamassassin (replace 'spamassassin' with 'spamc'
# if you use the spamc/spamd combination)
#
# The condition line ensures that only messages smaller than 250 kB
# (250 * 1024 = 256000 bytes) are processed by SpamAssassin. Most spam
# isn't bigger than a few k and working with big messages can bring
# SpamAssassin to its knees.
#
# The lock file ensures that only 1 spamassassin invocation happens
# at 1 time, to keep the load down.

:0fw: spamassassin.lock
* < 256000
| spamassassin

# Mails with a score of 15 or higher are almost certainly spam
# Let's put them in a different mailbox. (This is optional)
:0:
*^X-Spam-Level: \*
/var/spool/mail/spam

```

## 3) procmail -> python script

```bash
# ~/.procmailrc

:0Wc:
| /usr/bin/python [PATH TO PYTHON SCRIPT]
```

```python
# Python script

import sys
import email

full_msg = sys.stdin.readlines()

msg = email.message_from_string(full_msg.join());

to = msg['to']
from = msg['from']
subject = msg['subject']
body = msg['body']
```

